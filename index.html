<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>조교 급여 관리 (로컬 스토리지)</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font (Google Fonts) -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- SheetJS (XLSX) Library for Excel Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        * { transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease; }
        .icon { width: 1.25rem; height: 1.25rem; stroke: currentColor; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round; fill: none; }
        .icon-lg { width: 1.5rem; height: 1.5rem; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        .dark ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 4px; }
        .dark ::-webkit-scrollbar-thumb { background: #475569; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
        .dark ::-webkit-scrollbar-thumb:hover { background: #64748b; }
        .status-absence { background-color: #e5e7eb; } /* bg-gray-200 */
        .dark .status-absence { background-color: #4b5563; } /* dark:bg-gray-600 */
        .status-off-day { background-color: #f3f4f6; color: #9ca3af; } /* bg-gray-100 text-gray-400 */
        .dark .status-off-day { background-color: #374151; color: #6b7280; } /* dark:bg-gray-700 dark:text-gray-500 */
        .allowance-paid-leave { background-color: #dbeafe; } /* bg-blue-100 */
        .dark .allowance-paid-leave { background-color: #1e3a8a; } /* dark:bg-blue-900 */
        .allowance-holiday-work { background-color: #fee2e2; } /* bg-red-100 */
        .dark .allowance-holiday-work { background-color: #7f1d1d; } /* dark:bg-red-900 */
        .weekly-summary-row { background-color: #eef2ff; } /* bg-indigo-50 */
        .dark .weekly-summary-row { background-color: #312e81; } /* dark:bg-indigo-900 */
    </style>
    <script>
        tailwind.config = { darkMode: 'class' }
    </script>
</head>
<body class="bg-gray-100 text-gray-800 dark:bg-gray-900 dark:text-gray-200">

    <!-- Header / Navigation -->
    <header class="bg-white dark:bg-gray-800 shadow-md sticky top-0 z-30">
        <div class="container mx-auto flex justify-between items-center py-4 px-6">
            <h1 class="text-2xl md:text-3xl font-bold text-indigo-600 dark:text-indigo-400">조교 급여 관리</h1>
            <nav class="flex items-center space-x-2 md:space-x-4">
                <ul class="flex space-x-2 md:space-x-4">
                    <li>
                        <button id="usersMenuBtn" class="flex items-center space-x-2 px-4 py-2 rounded-lg font-medium">
                            <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2" /><circle cx="9" cy="7" r="4" /><path d="M22 21v-2a4 4 0 0 0-3-3.87" /><path d="M16 3.13a4 4 0 0 1 0 7.75" /></svg>
                            <span class="hidden sm:inline">사용자 목록</span>
                        </button>
                    </li>
                    <li>
                        <button id="salaryMenuBtn" class="flex items-center space-x-2 px-4 py-2 rounded-lg font-medium">
                            <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><rect width="20" height="14" x="2" y="5" rx="2" /><path d="M2 10h20" /></svg>
                            <span class="hidden sm:inline">조교급여</span>
                        </button>
                    </li>
                </ul>
                <button id="themeToggleBtn" class="p-2 rounded-full text-gray-600 hover:bg-gray-200 dark:text-gray-300 dark:hover:bg-gray-700">
                    <svg id="sunIcon" class="icon-lg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><circle cx="12" cy="12" r="4" /><path d="M12 2v2" /><path d="M12 20v2" /><path d="m4.93 4.93 1.41 1.41" /><path d="m17.66 17.66 1.41 1.41" /><path d="M2 12h2" /><path d="M20 12h2" /><path d="m4.93 19.07 1.41-1.41" /><path d="m17.66 6.34 1.41-1.41" /></svg>
                    <svg id="moonIcon" class="icon-lg hidden" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z" /></svg>
                </button>
            </nav>
        </div>
    </header>

    <!-- Main Content Area -->
    <main class="container mx-auto mt-8 p-4 sm:p-6 md:p-8">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6">
            <!-- 사용자 목록 섹션 -->
            <section id="usersSection">
                <div class="flex justify-between items-center mb-6 border-b border-gray-200 dark:border-gray-700 pb-3">
                    <h2 class="text-2xl font-semibold text-indigo-700 dark:text-indigo-400">사용자 목록</h2>
                    <button id="addUserBtn" class="flex items-center space-x-2 bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 shadow-md">
                        <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M5 12h14" /><path d="M12 5v14" /></svg>
                        <span>사용자 추가</span>
                    </button>
                </div>
                <div id="userListContainer" class="overflow-x-auto"></div>
            </section>

            <!-- 조교급여 섹션 -->
            <section id="salarySection" class="hidden">
                 <!-- Step 1: 사용자 선택 -->
                <div id="salaryStep1">
                    <h2 class="text-2xl font-semibold text-indigo-700 dark:text-indigo-400 mb-4">1. 급여 계산 대상 선택</h2>
                    <div class="space-y-4 bg-gray-50 dark:bg-gray-700 p-6 rounded-md">
                        <div>
                            <label for="affiliationSelect" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">소속 선택</label>
                            <select id="affiliationSelect" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 dark:bg-gray-600 dark:border-gray-500 dark:text-white"></select>
                        </div>
                        <div id="userSelectionContainer" class="hidden">
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">사용자 선택</label>
                            <div id="userCheckboxList" class="space-y-2 p-3 border rounded-md max-h-60 overflow-y-auto dark:border-gray-600"></div>
                        </div>
                        <div class="text-right">
                            <button id="goToStep2Btn" class="bg-indigo-600 text-white px-6 py-2 rounded-lg hover:bg-indigo-700 disabled:bg-gray-400" disabled>다음</button>
                        </div>
                    </div>
                </div>

                <!-- Step 2: 기간 선택 -->
                <div id="salaryStep2" class="hidden">
                    <h2 class="text-2xl font-semibold text-indigo-700 dark:text-indigo-400 mb-4">2. 계산 기간 선택</h2>
                    <div class="space-y-4 bg-gray-50 dark:bg-gray-700 p-6 rounded-md">
                        <div class="flex space-x-4">
                            <div class="flex-1">
                                <label for="yearSelect" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">연도</label>
                                <select id="yearSelect" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm dark:bg-gray-600 dark:border-gray-500"></select>
                            </div>
                            <div class="flex-1">
                                <label for="monthSelect" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">월</label>
                                <select id="monthSelect" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm dark:bg-gray-600 dark:border-gray-500"></select>
                            </div>
                        </div>
                        <div class="flex justify-between">
                            <button id="backToStep1Btn" class="bg-gray-500 text-white px-6 py-2 rounded-lg hover:bg-gray-600">이전</button>
                            <button id="generateRecordBtn" class="bg-indigo-600 text-white px-6 py-2 rounded-lg hover:bg-indigo-700">근무기록 생성</button>
                        </div>
                    </div>
                </div>

                <!-- Step 3: 근무기록 확인 및 수정 -->
                <div id="salaryStep3" class="hidden">
                     <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-semibold text-indigo-700 dark:text-indigo-400">3. 근무기록 확인 및 수정</h2>
                        <button id="backToStep2Btn" class="bg-gray-500 text-white px-6 py-2 rounded-lg hover:bg-gray-600">이전</button>
                    </div>
                    <div id="attendanceRecordContainer" class="overflow-x-auto"></div>
                    <div class="mt-6 text-right">
                        <button id="calculateSalaryBtn" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700">급여 계산하기</button>
                    </div>
                </div>
                
                <!-- Step 4: 급여 계산 결과 -->
                <div id="salaryStep4" class="hidden">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-semibold text-indigo-700 dark:text-indigo-400">4. 최종 급여 명세서</h2>
                        <div class="flex space-x-2">
                            <button id="exportToExcelBtn" class="flex items-center space-x-2 bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">
                                <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21.17 3.25a2.25 2.25 0 0 0-3.18 0L6 15.25v3.5h3.5l11.92-11.92a2.25 2.25 0 0 0 0-3.18Z"/><path d="m12 15-5 5"/><path d="M3 7v11a2 2 0 0 0 2 2h11"/></svg>
                                <span>엑셀로 내보내기</span>
                            </button>
                            <button id="backToStep3Btn" class="bg-gray-500 text-white px-6 py-2 rounded-lg hover:bg-gray-600">이전</button>
                        </div>
                    </div>
                    <div id="salaryResultContainer"></div>
                </div>
            </section>
        </div>
    </main>

    <!-- 사용자 추가/수정 패널 (사이드바) -->
    <div id="userFormPanel" class="fixed top-0 right-0 h-full w-full max-w-md bg-white dark:bg-gray-800 shadow-2xl transform translate-x-full transition-transform duration-300 ease-in-out z-50">
        <div class="flex flex-col h-full">
            <div class="flex justify-between items-center p-6 border-b dark:border-gray-700">
                <h3 id="userFormTitle" class="text-2xl font-semibold text-indigo-700 dark:text-indigo-400">사용자 추가</h3>
                <button id="closePanelBtn" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-600">
                    <svg class="w-6 h-6 text-gray-600 dark:text-gray-300" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 6 6 18" /><path d="m6 6 12 12" /></svg>
                </button>
            </div>
            <form id="userForm" class="p-6 flex-grow overflow-y-auto space-y-6">
                <input type="hidden" id="userId">
                <div>
                    <label for="name" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">이름</label>
                    <input type="text" id="name" required class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm dark:bg-gray-700 dark:border-gray-600">
                </div>
                <div>
                    <label for="rrn" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">주민등록번호</label>
                    <input type="text" id="rrn" placeholder="YYMMDD-XXXXXXX" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm dark:bg-gray-700 dark:border-gray-600">
                </div>
                <div>
                    <label for="affiliation" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">소속</label>
                    <input type="text" id="affiliation" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm dark:bg-gray-700 dark:border-gray-600">
                </div>
                <div>
                    <label for="phone" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">전화번호</label>
                    <input type="tel" id="phone" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm dark:bg-gray-700 dark:border-gray-600">
                </div>
                <div>
                    <label for="hourlyWage" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">시급</label>
                    <input type="number" id="hourlyWage" required class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm dark:bg-gray-700 dark:border-gray-600">
                </div>
                 <div>
                    <label for="weeklyRestDay" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">주휴일</label>
                    <select id="weeklyRestDay" required class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm dark:bg-gray-700 dark:border-gray-600">
                        <option value="일">일요일</option><option value="월">월요일</option><option value="화">화요일</option><option value="수">수요일</option><option value="목">목요일</option><option value="금">금요일</option><option value="토">토요일</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">근무 요일 및 시간</label>
                    <div id="workScheduleContainer" class="grid grid-cols-1 gap-3"></div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">세금 공제 방식</label>
                    <div class="flex space-x-4">
                        <label class="flex items-center"><input type="radio" name="taxType" value="4대보험" required class="text-indigo-600 focus:ring-indigo-500"><span class="ml-2">4대보험</span></label>
                        <label class="flex items-center"><input type="radio" name="taxType" value="3.3%" class="text-indigo-600 focus:ring-indigo-500"><span class="ml-2">3.3%</span></label>
                    </div>
                </div>
            </form>
            <div class="p-6 border-t dark:border-gray-700">
                <button type="submit" form="userForm" class="w-full bg-indigo-600 text-white px-4 py-3 rounded-lg hover:bg-indigo-700 font-semibold shadow-md">저장</button>
            </div>
        </div>
    </div>
    
    <div id="backdrop" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden"></div>

    <script type="module">
        // --- DOM 요소 ---
        const htmlElement = document.documentElement;
        const usersMenuBtn = document.getElementById('usersMenuBtn');
        const salaryMenuBtn = document.getElementById('salaryMenuBtn');
        const usersSection = document.getElementById('usersSection');
        const salarySection = document.getElementById('salarySection');
        const themeToggleBtn = document.getElementById('themeToggleBtn');
        const sunIcon = document.getElementById('sunIcon');
        const moonIcon = document.getElementById('moonIcon');
        
        // --- 사용자 관리 UI 요소 ---
        const addUserBtn = document.getElementById('addUserBtn');
        const userFormPanel = document.getElementById('userFormPanel');
        const closePanelBtn = document.getElementById('closePanelBtn');
        const backdrop = document.getElementById('backdrop');
        const userForm = document.getElementById('userForm');
        const userFormTitle = document.getElementById('userFormTitle');
        const userListContainer = document.getElementById('userListContainer');
        const workScheduleContainer = document.getElementById('workScheduleContainer');

        // --- 급여 관리 UI 요소 ---
        const salaryStep1 = document.getElementById('salaryStep1');
        const salaryStep2 = document.getElementById('salaryStep2');
        const salaryStep3 = document.getElementById('salaryStep3');
        const salaryStep4 = document.getElementById('salaryStep4');
        const affiliationSelect = document.getElementById('affiliationSelect');
        const userSelectionContainer = document.getElementById('userSelectionContainer');
        const userCheckboxList = document.getElementById('userCheckboxList');
        const goToStep2Btn = document.getElementById('goToStep2Btn');
        const yearSelect = document.getElementById('yearSelect');
        const monthSelect = document.getElementById('monthSelect');
        const backToStep1Btn = document.getElementById('backToStep1Btn');
        const generateRecordBtn = document.getElementById('generateRecordBtn');
        const backToStep2Btn = document.getElementById('backToStep2Btn');
        const attendanceRecordContainer = document.getElementById('attendanceRecordContainer');
        const calculateSalaryBtn = document.getElementById('calculateSalaryBtn');
        const backToStep3Btn = document.getElementById('backToStep3Btn');
        const salaryResultContainer = document.getElementById('salaryResultContainer');
        const exportToExcelBtn = document.getElementById('exportToExcelBtn');

        // --- 로컬 스토리지 키 ---
        const STORAGE_KEY = 'ta-assistants';
        let salaryCalculationState = {}; // 급여 계산 상태 저장

        // --- 스타일 클래스 정의 ---
        const activeMenuClasses = ['bg-indigo-600', 'text-white', 'shadow-md'];
        const inactiveMenuClasses = ['text-gray-600', 'hover:bg-indigo-100', 'hover:text-indigo-700', 'dark:text-gray-300', 'dark:hover:bg-gray-700', 'dark:hover:text-white'];

        // --- 테마 관리 ---
        function applyTheme(theme) {
            if (theme === 'dark') {
                htmlElement.classList.add('dark');
                sunIcon.classList.add('hidden');
                moonIcon.classList.remove('hidden');
            } else {
                htmlElement.classList.remove('dark');
                sunIcon.classList.remove('hidden');
                moonIcon.classList.add('hidden');
            }
        }

        function toggleTheme() {
            const newTheme = htmlElement.classList.contains('dark') ? 'light' : 'dark';
            applyTheme(newTheme);
            localStorage.setItem('theme', newTheme);
        }

        // --- 메뉴/섹션 관리 ---
        function updateMenuStyles(activeBtn, inactiveBtn) {
            activeBtn.classList.remove(...inactiveMenuClasses);
            activeBtn.classList.add(...activeMenuClasses);
            inactiveBtn.classList.remove(...activeMenuClasses);
            inactiveBtn.classList.add(...inactiveMenuClasses);
        }

        function showSection(sectionToShow, sectionToHide) {
             sectionToShow.classList.remove('hidden');
             sectionToHide.classList.add('hidden');
        }

        // --- 사용자 관리 패널(사이드바) 관리 ---
        function openUserPanel(user = null) {
            userForm.reset();
            document.querySelectorAll('.work-time-input').forEach(input => input.classList.add('hidden'));

            if (user && user.id) {
                userFormTitle.textContent = '사용자 수정';
                document.getElementById('userId').value = user.id;
                document.getElementById('name').value = user.name || '';
                document.getElementById('rrn').value = user.rrn || '';
                document.getElementById('affiliation').value = user.affiliation || '';
                document.getElementById('phone').value = user.phone || '';
                document.getElementById('hourlyWage').value = user.hourlyWage || '';
                document.getElementById('weeklyRestDay').value = user.weeklyRestDay || '일';

                if (user.workSchedule) {
                    Object.entries(user.workSchedule).forEach(([day, time]) => {
                        const checkbox = document.querySelector(`.day-checkbox[data-day="${day}"]`);
                        const timeInput = document.querySelector(`.work-time-input[data-day-input="${day}"]`);
                        if (checkbox && timeInput) {
                            checkbox.checked = true;
                            timeInput.value = time;
                            timeInput.classList.remove('hidden');
                        }
                    });
                }
                
                if(user.taxType) {
                    document.querySelector(`input[name="taxType"][value="${user.taxType}"]`).checked = true;
                }

            } else {
                userFormTitle.textContent = '사용자 추가';
                document.getElementById('userId').value = '';
            }
            backdrop.classList.remove('hidden');
            userFormPanel.classList.remove('translate-x-full');
        }

        function closeUserPanel() {
            userFormPanel.classList.add('translate-x-full');
            backdrop.classList.add('hidden');
        }

        // --- 로컬 스토리지 데이터 처리 ---
        function getUsersFromStorage() {
            const usersJSON = localStorage.getItem(STORAGE_KEY);
            return usersJSON ? JSON.parse(usersJSON) : [];
        }

        function saveUsersToStorage(users) {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(users));
        }

        function fetchAndRenderUsers() {
            const users = getUsersFromStorage();
            renderUserList(users);
        }

        function renderUserList(users) {
            if (users.length === 0) {
                userListContainer.innerHTML = `<div class="text-center py-10 px-6 bg-gray-50 dark:bg-gray-700 rounded-md">
                    <p class="text-gray-500 dark:text-gray-400">등록된 사용자가 없습니다.</p>
                    <p class="text-sm text-gray-400 dark:text-gray-500 mt-2">'사용자 추가' 버튼을 눌러 새로운 조교를 등록하세요.</p>
                </div>`;
                return;
            }

            userListContainer.innerHTML = `
                <table class="min-w-full bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg">
                    <thead class="bg-gray-50 dark:bg-gray-700">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">이름</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">소속</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">시급</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">관리</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200 dark:divide-gray-700">
                        ${users.map(user => `
                            <tr class="hover:bg-gray-50 dark:hover:bg-gray-700">
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 dark:text-white">${user.name}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-300">${user.affiliation}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-300">${(user.hourlyWage || 0).toLocaleString()}원</td>
                                <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-2">
                                    <button class="edit-btn text-indigo-600 hover:text-indigo-900 dark:text-indigo-400 dark:hover:text-indigo-200" data-id="${user.id}">수정</button>
                                    <button class="delete-btn text-red-600 hover:text-red-900 dark:text-red-400 dark:hover:text-red-200" data-id="${user.id}">삭제</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        function handleFormSubmit(e) {
            e.preventDefault();
            
            const workSchedule = {};
            document.querySelectorAll('input.day-checkbox:checked').forEach(checkbox => {
                const day = checkbox.dataset.day;
                const timeInput = document.querySelector(`.work-time-input[data-day-input="${day}"]`);
                if (timeInput && timeInput.value.trim() !== '') {
                    workSchedule[day] = timeInput.value.trim();
                }
            });

            const userData = {
                name: document.getElementById('name').value,
                rrn: document.getElementById('rrn').value,
                affiliation: document.getElementById('affiliation').value,
                phone: document.getElementById('phone').value,
                hourlyWage: parseFloat(document.getElementById('hourlyWage').value) || 0,
                weeklyRestDay: document.getElementById('weeklyRestDay').value,
                workSchedule: workSchedule,
                taxType: document.querySelector('input[name="taxType"]:checked')?.value || null,
            };

            const id = document.getElementById('userId').value;
            let users = getUsersFromStorage();

            if (id) {
                users = users.map(user => user.id === id ? { ...user, ...userData, id: id } : user);
            } else {
                userData.id = `user_${Date.now()}`;
                users.push(userData);
            }
            
            saveUsersToStorage(users);
            fetchAndRenderUsers();
            closeUserPanel();
        }

        function handleUserListClick(e) {
            const target = e.target;
            const id = target.dataset.id;
            if (!id) return;

            if (target.classList.contains('edit-btn')) {
                const users = getUsersFromStorage();
                const userToEdit = users.find(user => user.id === id);
                if (userToEdit) {
                    openUserPanel(userToEdit);
                }
            }

            if (target.classList.contains('delete-btn')) {
                let users = getUsersFromStorage();
                users = users.filter(user => user.id !== id);
                saveUsersToStorage(users);
                fetchAndRenderUsers();
            }
        }

        // --- 급여 관리 로직 ---
        function initializeSalaryPage() {
            const users = getUsersFromStorage();
            const affiliations = [...new Set(users.map(u => u.affiliation).filter(Boolean))];
            affiliationSelect.innerHTML = '<option value="">소속을 선택하세요</option>';
            affiliations.forEach(aff => {
                affiliationSelect.innerHTML += `<option value="${aff}">${aff}</option>`;
            });
            resetSalarySteps();
        }
        
        function resetSalarySteps() {
            salaryStep1.classList.remove('hidden');
            salaryStep2.classList.add('hidden');
            salaryStep3.classList.add('hidden');
            salaryStep4.classList.add('hidden');
            userSelectionContainer.classList.add('hidden');
            affiliationSelect.value = '';
            goToStep2Btn.disabled = true;
            salaryCalculationState = {};
        }
        
        function timeToMinutes(timeStr) {
            if (!timeStr || !timeStr.includes(':')) return 0;
            const [hours, minutes] = timeStr.split(':').map(Number);
            return hours * 60 + minutes;
        }

        function calculateWorkHours(start, end) {
            let startMinutes = timeToMinutes(start);
            let endMinutes = timeToMinutes(end);
            if (endMinutes < startMinutes) endMinutes += 24 * 60; // 야간 근무 처리
            return (endMinutes - startMinutes) / 60;
        }

        function getContractedWeeklyHours(user) {
            if (!user.workSchedule) return { totalHours: 0, workDays: 0 };
            let totalHours = 0;
            const workDays = Object.keys(user.workSchedule).length;
            for (const time of Object.values(user.workSchedule)) {
                const [start, end] = time.split('~');
                totalHours += calculateWorkHours(start, end);
            }
            return { totalHours, workDays };
        }

        affiliationSelect.addEventListener('change', () => {
            const selectedAffiliation = affiliationSelect.value;
            if (!selectedAffiliation) {
                userSelectionContainer.classList.add('hidden');
                return;
            }
            const users = getUsersFromStorage().filter(u => u.affiliation === selectedAffiliation);
            userCheckboxList.innerHTML = users.map(user => `
                <label class="flex items-center space-x-2 p-2 rounded-md hover:bg-gray-100 dark:hover:bg-gray-600">
                    <input type="checkbox" name="selectedUsers" value="${user.id}" class="rounded text-indigo-600 focus:ring-indigo-500">
                    <span>${user.name}</span>
                </label>
            `).join('');
            userSelectionContainer.classList.remove('hidden');
        });

        userCheckboxList.addEventListener('change', () => {
            goToStep2Btn.disabled = document.querySelectorAll('input[name="selectedUsers"]:checked').length === 0;
        });

        goToStep2Btn.addEventListener('click', () => {
            salaryCalculationState.selectedUserIds = Array.from(document.querySelectorAll('input[name="selectedUsers"]:checked')).map(cb => cb.value);
            
            const currentYear = new Date().getFullYear();
            yearSelect.innerHTML = '';
            for (let i = currentYear + 1; i >= currentYear - 5; i--) yearSelect.innerHTML += `<option value="${i}">${i}년</option>`;
            yearSelect.value = currentYear;

            monthSelect.innerHTML = '';
            for (let i = 1; i <= 12; i++) monthSelect.innerHTML += `<option value="${i}">${i}월</option>`;
            monthSelect.value = new Date().getMonth() + 1;

            salaryStep1.classList.add('hidden');
            salaryStep2.classList.remove('hidden');
        });
        
        backToStep1Btn.addEventListener('click', () => {
            salaryStep2.classList.add('hidden');
            salaryStep1.classList.remove('hidden');
        });

        generateRecordBtn.addEventListener('click', () => {
            salaryCalculationState.year = parseInt(yearSelect.value);
            salaryCalculationState.month = parseInt(monthSelect.value);
            generateAttendanceTable();
            salaryStep2.classList.add('hidden');
            salaryStep3.classList.remove('hidden');
        });

        backToStep2Btn.addEventListener('click', () => {
            salaryStep3.classList.add('hidden');
            salaryStep2.classList.remove('hidden');
        });
        
        calculateSalaryBtn.addEventListener('click', () => {
            calculateAndShowResults();
            salaryStep3.classList.add('hidden');
            salaryStep4.classList.remove('hidden');
        });

        backToStep3Btn.addEventListener('click', () => {
            salaryStep4.classList.add('hidden');
            salaryStep3.classList.remove('hidden');
        });

        function generateAttendanceTable() {
            const { selectedUserIds, year, month } = salaryCalculationState;
            const allUsers = getUsersFromStorage();
            const selectedUsers = allUsers.filter(u => selectedUserIds.includes(u.id));
            const daysInMonth = new Date(year, month, 0).getDate();
            const dayNames = ['일', '월', '화', '수', '목', '금', '토'];

            let tableHTML = `
                <table class="min-w-full bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg text-sm">
                    <thead class="bg-gray-50 dark:bg-gray-700">
                        <tr>
                            <th class="p-2 text-left text-xs font-medium uppercase">날짜</th>
                            <th class="p-2 text-left text-xs font-medium uppercase">이름</th>
                            <th class="p-2 text-left text-xs font-medium uppercase">상태</th>
                            <th class="p-2 text-left text-xs font-medium uppercase">수당적용</th>
                            <th class="p-2 text-left text-xs font-medium uppercase">계획</th>
                            <th class="p-2 text-left text-xs font-medium uppercase">출근</th>
                            <th class="p-2 text-left text-xs font-medium uppercase">퇴근</th>
                            <th class="p-2 text-left text-xs font-medium uppercase">일일급여</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200 dark:divide-gray-700">`;
            
            for (let day = 1; day <= daysInMonth; day++) {
                for (const user of selectedUsers) {
                    const date = new Date(year, month - 1, day);
                    const dayName = dayNames[date.getDay()];
                    const isWorkDay = user.workSchedule && user.workSchedule[dayName];
                    const rowId = `row-${user.id}-${day}`;
                    
                    const [startTime, endTime] = isWorkDay ? user.workSchedule[dayName].split('~') : ['', ''];

                    tableHTML += `
                        <tr id="${rowId}" data-user-id="${user.id}" data-day="${day}" data-day-name="${dayName}" class="${!isWorkDay ? 'status-off-day' : ''}">
                            <td class="p-2 whitespace-nowrap">${month}/${day} (${dayName})</td>
                            <td class="p-2 whitespace-nowrap">${user.name}</td>
                            <td class="p-2">
                                <select class="status-select w-full rounded-md border-gray-300 dark:bg-gray-600">
                                    <option value="normal" ${isWorkDay ? 'selected' : ''}>정상</option>
                                    <option value="extra-work">계약 외 출근</option>
                                    <option value="off-day" ${!isWorkDay ? 'selected' : ''}>미출근</option>
                                    <option value="absence">결근</option>
                                </select>
                            </td>
                            <td class="p-2 space-x-2">
                                <label><input type="checkbox" class="allowance-checkbox" value="paid-leave"> 유급</label>
                                <label><input type="checkbox" class="allowance-checkbox" value="holiday-work"> 공휴일</label>
                            </td>
                            <td class="p-2 whitespace-nowrap">${isWorkDay ? user.workSchedule[dayName] : '-'}</td>
                            <td class="p-2"><input type="time" class="actual-start w-full rounded-md border-gray-300 dark:bg-gray-600" value="${startTime || ''}"></td>
                            <td class="p-2"><input type="time" class="actual-end w-full rounded-md border-gray-300 dark:bg-gray-600" value="${endTime || ''}"></td>
                            <td class="p-2 font-medium text-right"><span class="daily-pay-val">0</span> 원</td>
                        </tr>
                    `;

                    // 주휴일인 경우, 주휴수당 요약 행 추가
                    if (dayName === user.weeklyRestDay || day === daysInMonth) {
                         const weekNumber = Math.ceil((date.getDate() + (new Date(year, month - 1, 1).getDay() || 7) - 1) / 7);
                         tableHTML += `
                            <tr class="weekly-summary-row" data-user-id="${user.id}" data-week-number="${weekNumber}">
                                <td colspan="2" class="p-2 font-bold text-indigo-700 dark:text-indigo-300">${weekNumber}주차 요약 (${user.name})</td>
                                <td colspan="2" class="p-2">총 근무: <span class="weekly-hours">0</span>시간</td>
                                <td colspan="4" class="p-2">
                                    <label class="flex items-center space-x-2">
                                        <input type="checkbox" class="weekly-allowance-cb" data-allowance="0">
                                        <span>주휴수당 지급 (<span class="weekly-allowance-amount">0</span>원)</span>
                                    </label>
                                </td>
                            </tr>
                         `;
                    }
                }
            }


            tableHTML += `</tbody></table>`;
            attendanceRecordContainer.innerHTML = tableHTML;
            
            attendanceRecordContainer.querySelectorAll('.status-select, .allowance-checkbox, .actual-start, .actual-end').forEach(el => {
                el.addEventListener('change', (e) => {
                    const row = e.target.closest('tr');
                    updateRowAppearanceAndState(row);
                    updateWeeklySummaries();
                });
            });
            
            // 초기 상태 업데이트
            attendanceRecordContainer.querySelectorAll('tr[data-day]').forEach(row => {
                updateRowAppearanceAndState(row);
            });
            updateWeeklySummaries();
        }

        function updateRowAppearanceAndState(row) {
            if (!row || !row.matches('tr[data-day]')) return;

            const statusSelect = row.querySelector('.status-select');
            const startInput = row.querySelector('.actual-start');
            const endInput = row.querySelector('.actual-end');
            
            row.classList.remove('status-absence', 'allowance-paid-leave', 'allowance-holiday-work', 'status-off-day');
            
            const status = statusSelect.value;
            const isPaidLeave = row.querySelector('.allowance-checkbox[value="paid-leave"]').checked;
            const isHolidayWork = row.querySelector('.allowance-checkbox[value="holiday-work"]').checked;
            
            if (status === 'absence' || status === 'off-day') {
                startInput.disabled = true;
                endInput.disabled = true;
            } else {
                startInput.disabled = false;
                endInput.disabled = false;
            }

            if (status === 'absence') row.classList.add('status-absence');
            if (status === 'off-day') row.classList.add('status-off-day');
            if (isPaidLeave) row.classList.add('allowance-paid-leave');
            if (isHolidayWork) row.classList.add('allowance-holiday-work');
            
            // 일일 급여 실시간 계산
            calculateDailyPay(row);
        }
        
        function calculateDailyPay(row) {
            const userId = row.dataset.userId;
            const user = getUsersFromStorage().find(u => u.id === userId);
            if (!user) return;

            let dailyPay = 0;
            const hourlyWage = user.hourlyWage || 0;
            const status = row.querySelector('.status-select')?.value;
            if (status === 'absence' || status === 'off-day') {
                row.querySelector('.daily-pay-val').textContent = '0';
                return;
            }

            const isPaidLeave = row.querySelector('.allowance-checkbox[value="paid-leave"]').checked;
            const isHolidayWork = row.querySelector('.allowance-checkbox[value="holiday-work"]').checked;
            
            const scheduledTime = row.cells[4].textContent;
            const [scheduledStart, scheduledEnd] = scheduledTime.split('~');
            const scheduledHours = calculateWorkHours(scheduledStart, scheduledEnd);
            
            const actualStart = row.querySelector('.actual-start').value;
            const actualEnd = row.querySelector('.actual-end').value;
            const actualHours = calculateWorkHours(actualStart, actualEnd);

            // 야간 시간 계산 (22:00 ~ 06:00)
            const nightStartMinutes = 22 * 60;
            const nightEndMinutes = (24 + 6) * 60;
            let startMinutes = timeToMinutes(actualStart);
            let endMinutes = timeToMinutes(actualEnd);
            if (endMinutes < startMinutes) endMinutes += 24 * 60;

            const nightHours = (Math.max(0, Math.min(endMinutes, nightEndMinutes) - Math.max(startMinutes, nightStartMinutes))) / 60;
            const nightAllowance = nightHours * hourlyWage * 0.5;

            if (isPaidLeave) {
                dailyPay = scheduledHours * hourlyWage;
            } else if (isHolidayWork) {
                dailyPay = actualHours * hourlyWage * 1.5 + nightAllowance;
            } else if (status === 'extra-work') {
                dailyPay = actualHours * hourlyWage * 1.5 + nightAllowance;
            } else { // normal
                const baseHours = Math.min(actualHours, scheduledHours);
                const overtimeHours = Math.max(0, actualHours - scheduledHours);
                dailyPay = (baseHours * hourlyWage) + (overtimeHours * hourlyWage * 1.5) + nightAllowance;
            }
            
            row.querySelector('.daily-pay-val').textContent = Math.round(dailyPay).toLocaleString();
        }
        
        function updateWeeklySummaries() {
            const allUsers = getUsersFromStorage();
            const { selectedUserIds, year, month } = salaryCalculationState;
            const selectedUsers = allUsers.filter(u => selectedUserIds.includes(u.id));

            selectedUsers.forEach(user => {
                const weeklyData = {};
                const rows = attendanceRecordContainer.querySelectorAll(`tr[data-user-id="${user.id}"][data-day]`);
                
                rows.forEach(row => {
                    const day = parseInt(row.dataset.day);
                    const date = new Date(year, month - 1, day);
                    const weekNumber = Math.ceil((date.getDate() + (new Date(year, month - 1, 1).getDay() || 7) - 1) / 7);
                    if (!weeklyData[weekNumber]) weeklyData[weekNumber] = { hours: 0, hasAbsence: false };

                    const status = row.querySelector('.status-select')?.value;
                    if (status === 'absence') weeklyData[weekNumber].hasAbsence = true;
                    if (status === 'absence' || status === 'off-day') return;

                    const isPaidLeave = row.querySelector('.allowance-checkbox[value="paid-leave"]')?.checked;
                    const scheduledTime = row.cells[4].textContent;
                    const [scheduledStart, scheduledEnd] = scheduledTime.split('~');
                    const scheduledHours = calculateWorkHours(scheduledStart, scheduledEnd);
                    
                    const actualStart = row.querySelector('.actual-start')?.value;
                    const actualEnd = row.querySelector('.actual-end')?.value;
                    const actualHours = calculateWorkHours(actualStart, actualEnd);

                    weeklyData[weekNumber].hours += isPaidLeave ? scheduledHours : actualHours;
                });

                Object.entries(weeklyData).forEach(([week, data]) => {
                    const summaryRow = attendanceRecordContainer.querySelector(`.weekly-summary-row[data-user-id="${user.id}"][data-week-number="${week}"]`);
                    if (summaryRow) {
                        summaryRow.querySelector('.weekly-hours').textContent = data.hours.toFixed(1);
                        const isEligible = data.hours >= 15 && !data.hasAbsence;
                        
                        const { totalHours, workDays } = getContractedWeeklyHours(user);
                        const dailyAverageHours = workDays > 0 ? totalHours / workDays : 0;
                        const allowance = isEligible ? dailyAverageHours * user.hourlyWage : 0;
                        
                        const checkbox = summaryRow.querySelector('.weekly-allowance-cb');
                        summaryRow.querySelector('.weekly-allowance-amount').textContent = Math.round(allowance).toLocaleString();
                        checkbox.dataset.allowance = allowance;
                        checkbox.disabled = !isEligible;
                        checkbox.checked = isEligible;
                    }
                });
            });
        }
        
        function calculateDeductions(totalPay) {
            const deductions = {
                nationalPension: 0, healthInsurance: 0, longTermCareInsurance: 0,
                employmentInsurance: 0, incomeTax: 0, localIncomeTax: 0, total: 0
            };

            deductions.employmentInsurance = totalPay * 0.009;

            if (totalPay >= 1050000) {
                deductions.nationalPension = totalPay * 0.045;
                deductions.healthInsurance = totalPay * 0.03545;
                deductions.longTermCareInsurance = deductions.healthInsurance * 0.1295;
            }

            if (totalPay > 1060000) {
                 deductions.incomeTax = (totalPay * 0.03); // 단순 예시 세율
            }
            deductions.localIncomeTax = deductions.incomeTax * 0.1;

            deductions.total = Object.values(deductions).reduce((acc, val) => acc + val, 0);
            return deductions;
        }
        
        function calculateAndShowResults() {
            const allUsers = getUsersFromStorage();
            const { selectedUserIds } = salaryCalculationState;
            const selectedUsers = allUsers.filter(u => selectedUserIds.includes(u.id));
            let resultsHTML = '';
            salaryCalculationState.results = []; // 결과 저장 초기화

            selectedUsers.forEach(user => {
                const hourlyWage = user.hourlyWage || 0;
                let totalBasePay = 0, totalOvertimePay = 0, totalHolidayPay = 0, totalPaidLeavePay = 0, totalNightAllowance = 0;
                
                const rows = attendanceRecordContainer.querySelectorAll(`tr[data-user-id="${user.id}"][data-day]`);
                rows.forEach(row => {
                    const status = row.querySelector('.status-select')?.value;
                    if (status === 'absence' || status === 'off-day') return;

                    const isPaidLeave = row.querySelector('.allowance-checkbox[value="paid-leave"]').checked;
                    const isHolidayWork = row.querySelector('.allowance-checkbox[value="holiday-work"]').checked;
                    
                    const scheduledTime = row.cells[4].textContent;
                    const [scheduledStart, scheduledEnd] = scheduledTime.split('~');
                    const scheduledHours = calculateWorkHours(scheduledStart, scheduledEnd);
                    
                    const actualStart = row.querySelector('.actual-start').value;
                    const actualEnd = row.querySelector('.actual-end').value;
                    const actualHours = calculateWorkHours(actualStart, actualEnd);

                    const nightStartMinutes = 22 * 60;
                    const nightEndMinutes = (24 + 6) * 60;
                    let startMinutes = timeToMinutes(actualStart);
                    let endMinutes = timeToMinutes(actualEnd);
                    if (endMinutes < startMinutes) endMinutes += 24 * 60;
                    const nightHours = (Math.max(0, Math.min(endMinutes, nightEndMinutes) - Math.max(startMinutes, nightStartMinutes))) / 60;
                    totalNightAllowance += nightHours * hourlyWage * 0.5;

                    if (isPaidLeave) {
                        totalPaidLeavePay += scheduledHours * hourlyWage;
                        return;
                    }

                    if (isHolidayWork) {
                        totalHolidayPay += actualHours * hourlyWage * 1.5;
                    } else if (status === 'extra-work') {
                        totalOvertimePay += actualHours * hourlyWage * 1.5;
                    } else { // normal
                        const baseHours = Math.min(actualHours, scheduledHours);
                        const overtimeHours = Math.max(0, actualHours - scheduledHours);
                        totalBasePay += baseHours * hourlyWage;
                        totalOvertimePay += overtimeHours * hourlyWage * 1.5;
                    }
                });
                
                let totalWeeklyAllowance = 0;
                attendanceRecordContainer.querySelectorAll(`.weekly-summary-row[data-user-id="${user.id}"] .weekly-allowance-cb:checked`).forEach(cb => {
                    totalWeeklyAllowance += parseFloat(cb.dataset.allowance);
                });

                const totalPay = totalBasePay + totalOvertimePay + totalHolidayPay + totalPaidLeavePay + totalWeeklyAllowance + totalNightAllowance;
                let deductions = { total: 0 };
                let deductionDetailsHTML = '';

                if (user.taxType === '4대보험') {
                    deductions = calculateDeductions(totalPay);
                    deductionDetailsHTML = `
                        <h4 class="col-span-2 text-md font-semibold mt-4 mb-2 text-gray-700 dark:text-gray-300">4대보험 공제 내역</h4>
                        <div><span class="font-medium text-gray-600 dark:text-gray-400">국민연금:</span> ${Math.round(deductions.nationalPension).toLocaleString()} 원</div>
                        <div><span class="font-medium text-gray-600 dark:text-gray-400">건강보험:</span> ${Math.round(deductions.healthInsurance).toLocaleString()} 원</div>
                        <div><span class="font-medium text-gray-600 dark:text-gray-400">장기요양:</span> ${Math.round(deductions.longTermCareInsurance).toLocaleString()} 원</div>
                        <div><span class="font-medium text-gray-600 dark:text-gray-400">고용보험:</span> ${Math.round(deductions.employmentInsurance).toLocaleString()} 원</div>
                        <div><span class="font-medium text-gray-600 dark:text-gray-400">소득세:</span> ${Math.round(deductions.incomeTax).toLocaleString()} 원</div>
                        <div><span class="font-medium text-gray-600 dark:text-gray-400">지방소득세:</span> ${Math.round(deductions.localIncomeTax).toLocaleString()} 원</div>
                    `;
                } else if (user.taxType === '3.3%') {
                    deductions.total = totalPay * 0.033;
                    deductionDetailsHTML = `<div><span class="font-medium text-gray-600 dark:text-gray-400">사업소득세 (3.3%):</span> ${Math.round(deductions.total).toLocaleString()} 원</div>`;
                }

                const netPay = totalPay - deductions.total;

                resultsHTML += `
                    <div class="user-salary-card bg-gray-50 dark:bg-gray-700 p-6 rounded-lg mb-4">
                        <h3 class="text-xl font-bold text-indigo-600 dark:text-indigo-400 mb-4">${user.name} (${user.affiliation})</h3>
                        <div class="grid grid-cols-2 gap-4 text-sm">
                            <h4 class="col-span-2 text-md font-semibold mb-2 text-gray-700 dark:text-gray-300">급여 항목</h4>
                            <div><span class="font-medium text-gray-600 dark:text-gray-400">기본급여:</span> ${Math.round(totalBasePay).toLocaleString()} 원</div>
                            <div><span class="font-medium text-gray-600 dark:text-gray-400">연장수당:</span> ${Math.round(totalOvertimePay).toLocaleString()} 원</div>
                            <div><span class="font-medium text-gray-600 dark:text-gray-400">야간수당:</span> ${Math.round(totalNightAllowance).toLocaleString()} 원</div>
                            <div><span class="font-medium text-gray-600 dark:text-gray-400">유급수당:</span> ${Math.round(totalPaidLeavePay).toLocaleString()} 원</div>
                            <div><span class="font-medium text-gray-600 dark:text-gray-400">공휴일수당:</span> ${Math.round(totalHolidayPay).toLocaleString()} 원</div>
                            <div><span class="font-medium text-gray-600 dark:text-gray-400">주휴수당:</span> ${Math.round(totalWeeklyAllowance).toLocaleString()} 원</div>
                            
                            <div class="col-span-2 border-t pt-4 mt-2 dark:border-gray-600">
                                <span class="font-semibold text-gray-700 dark:text-gray-300">총 지급액 (과세 대상):</span> ${Math.round(totalPay).toLocaleString()} 원
                            </div>
                            ${deductionDetailsHTML}
                             <div class="col-span-2 border-t pt-4 mt-4 dark:border-gray-600"></div>
                            <div><span class="font-semibold text-gray-700 dark:text-gray-300">총 공제액:</span> ${Math.round(deductions.total).toLocaleString()} 원</div>
                            <div class="text-lg font-bold text-green-600 dark:text-green-400">실지급액: ${Math.round(netPay).toLocaleString()} 원</div>
                        </div>
                    </div>
                `;
                
                // 엑셀 내보내기를 위해 결과 저장
                salaryCalculationState.results.push({
                    userName: user.name,
                    affiliation: user.affiliation,
                    totalPay: Math.round(totalPay),
                    deductions: {
                        nationalPension: Math.round(deductions.nationalPension || 0),
                        healthInsurance: Math.round(deductions.healthInsurance || 0),
                        longTermCareInsurance: Math.round(deductions.longTermCareInsurance || 0),
                        employmentInsurance: Math.round(deductions.employmentInsurance || 0),
                        incomeTax: Math.round(deductions.incomeTax || 0),
                        localIncomeTax: Math.round(deductions.localIncomeTax || 0),
                    },
                    netPay: Math.round(netPay)
                });
            });
            salaryResultContainer.innerHTML = resultsHTML;
        }

        function handleExcelExport() {
            const results = salaryCalculationState.results;
            if (!results || results.length === 0) {
                alert("내보낼 데이터가 없습니다.");
                return;
            }

            const exportData = results.map(res => ({
                '이름': res.userName,
                '소속': res.affiliation,
                '세전금액': res.totalPay,
                '국민연금': res.deductions.nationalPension,
                '건강보험': res.deductions.healthInsurance,
                '장기요양보험': res.deductions.longTermCareInsurance,
                '고용보험': res.deductions.employmentInsurance,
                '소득세': res.deductions.incomeTax,
                '지방소득세': res.deductions.localIncomeTax,
                '세후금액': res.netPay
            }));

            const ws = XLSX.utils.json_to_sheet(exportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "급여명세서");

            const headerStyle = {
                font: { bold: true, color: { rgb: "FFFFFF" } },
                fill: { fgColor: { rgb: "4F46E5" } }, // Indigo-600
                alignment: { horizontal: "center", vertical: "center" }
            };

            const headers = Object.keys(exportData[0]);
            for (let i = 0; i < headers.length; i++) {
                const cellRef = XLSX.utils.encode_cell({ c: i, r: 0 });
                if (ws[cellRef]) ws[cellRef].s = headerStyle;
            }
            
            ws['!cols'] = [
                { wch: 15 }, { wch: 20 }, { wch: 15 }, { wch: 15 },
                { wch: 15 }, { wch: 15 }, { wch: 15 }, { wch: 15 },
                { wch: 15 }, { wch: 15 }
            ];

            const { year, month } = salaryCalculationState;
            XLSX.writeFile(wb, `${year}년 ${month}월 조교급여명세서.xlsx`);
        }


        // --- 페이지 동적 컨텐츠 생성 ---
        function createWorkScheduleInputs() {
            const days = ['월', '화', '수', '목', '금', '토', '일'];
            workScheduleContainer.innerHTML = days.map(day => `
                <div class="flex items-center justify-between p-2 border rounded-md dark:border-gray-600">
                    <label class="flex items-center space-x-3 cursor-pointer">
                        <input type="checkbox" data-day="${day}" class="day-checkbox rounded text-indigo-600 focus:ring-indigo-500">
                        <span class="font-medium">${day}</span>
                    </label>
                    <input type="text" data-day-input="${day}" placeholder="09:00~18:00" class="work-time-input hidden w-36 text-center px-2 py-1 border border-gray-300 rounded-md text-sm dark:bg-gray-600 dark:border-gray-500">
                </div>
            `).join('');
        }

        // --- 이벤트 리스너 설정 ---
        function setupEventListeners() {
            themeToggleBtn.addEventListener('click', toggleTheme);
            usersMenuBtn.addEventListener('click', () => {
                showSection(usersSection, salarySection);
                updateMenuStyles(usersMenuBtn, salaryMenuBtn);
            });
            salaryMenuBtn.addEventListener('click', () => {
                showSection(salarySection, usersSection);
                updateMenuStyles(salaryMenuBtn, usersMenuBtn);
                initializeSalaryPage();
            });
            addUserBtn.addEventListener('click', () => openUserPanel());
            closePanelBtn.addEventListener('click', closeUserPanel);
            backdrop.addEventListener('click', closeUserPanel);
            userForm.addEventListener('submit', handleFormSubmit);
            userListContainer.addEventListener('click', handleUserListClick);
            exportToExcelBtn.addEventListener('click', handleExcelExport);
            
            userForm.addEventListener('change', (e) => {
                if (e.target.classList.contains('day-checkbox')) {
                    const day = e.target.dataset.day;
                    const timeInput = document.querySelector(`input[data-day-input="${day}"]`);
                    if (e.target.checked) {
                        timeInput.classList.remove('hidden');
                    } else {
                        timeInput.classList.add('hidden');
                        timeInput.value = '';
                    }
                }
            });
        }

        // --- 페이지 초기화 ---
        function initializePage() {
            const savedTheme = localStorage.getItem('theme');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            applyTheme(savedTheme || (prefersDark ? 'dark' : 'light'));
            
            createWorkScheduleInputs();
            setupEventListeners();
            updateMenuStyles(usersMenuBtn, salaryMenuBtn);
            fetchAndRenderUsers();
        }

        window.addEventListener('load', initializePage);
    </script>
</body>
</html>
